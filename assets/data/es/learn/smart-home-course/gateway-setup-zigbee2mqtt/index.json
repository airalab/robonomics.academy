{"hash":"e6c519792deb242508dbdc929978fb576e31f14b","data":{"course":{"id":"316446f863081c9c880bd29e17486571","title":"Lección #4a, Configuración de la Puerta de Enlace: Zigbee2MQTT","description":"curso de asistente doméstico","content":"\n## Introducción\n\nEste es un escenario de configuración para conectar dispositivos utilizando el adaptador Zigbee y el puente Zigbee2MQTT. Si tienes el [JetHome USB JetStick Z2](https://jethome.ru/z2/?sl=en) (que tiene todo el firmware necesario), simplemente puedes seguir estas instrucciones. Sin embargo, si tienes otro adaptador, lo primero que necesitas hacer es flashearlo con el software Zigbee2MQTT. Puedes encontrar instrucciones para tu dispositivo [aquí](https://www.zigbee2mqtt.io/guide/adapters/).\n\nTambién necesitarás un dispositivo inteligente para probar su conexión con Home Assistant.\n\n\n## Instrucciones\n\n<List type=\"numbers\">\n\n<li>\n\nInstalación de Software\n\n<List>\n\n  <li>\n    Configura el repositorio del entorno de ejecución de Node.js e instálalo con las dependencias requeridas:\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>sudo curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash - </LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo apt-get install -y nodejs git make g++ gcc</LessonCodeWrapper>\n\n  </li>\n\n  <li>\n    Verifica que las versiones correctas de Node.js (v14.X, V16.x, V17.x o V18.X) y el gestor de paquetes <code class=\"nowb\">npm</code> (6.X, 7.X o 8.X) instalados automáticamente con Node.js, hayan sido instalados:\n    <LessonCodeWrapper language=\"bash\" noLines>node --version</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm --version</LessonCodeWrapper>\n  </li>\n\n  <li>\n    Crea un directorio para Zigbee2MQTT y establece tu usuario como propietario de él:\n    <LessonCodeWrapper language=\"bash\" noLines>sudo mkdir /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo chown -R ${USER}: /opt/zigbee2mqtt</LessonCodeWrapper>\n  </li>\n\n  <li>\n    Clona el repositorio de Zigbee2MQTT:\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\n    git clone --depth 1 --branch 1.28.4 https://github.com/Koenkk/zigbee2mqtt.git /opt/zigbee2mqtt\n    </LessonCodeWrapper>\n  </li>\n\n  <li>\n    Instalar dependencias. Tenga en cuenta que <code>npm ci</code> podría producir algunas advertencias que se pueden ignorar.\n    <LessonCodeWrapper language=\"bash\" noLines>cd /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm ci</LessonCodeWrapper>\n  </li>\n\n</List>\n</li>\n\n<li>\n\nConexión y Configuración del Adaptador\n\n<List>\n\n<li>\n\nConecta el adaptador Zigbee a la Raspberry Pi. Luego necesitas encontrar la ubicación del stick. Para esto escribe el siguiente comando:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nls -l /dev/serial/by-id\n</LessonCodeWrapper>\n\nLa salida debería verse como:\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noCopyIcon>\nubuntu@ubuntu:~$ ls -l /dev/serial/by-id\ntotal 0\nlrwxrwxrwx 1 root root 13 Oct 10 01:44 usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0 -> ../../ttyUSB0\n</LessonCodeWrapper>\n\nEn este ejemplo, el directorio de conexión del stick es <code>ttyUSB0</code>.\n</li>\n\n<li>\n\nEditar el archivo <code>configuration.yaml</code> antes de iniciar Zigbee2MQTT:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnano /opt/zigbee2mqtt/data/configuration.yaml\n</LessonCodeWrapper>\n\nLa configuración básica necesita algunos ajustes. Cambie las siguientes declaraciones:\n\n\\- <code>homeassistant:</code> a <code>true</code>, se conectará automáticamente los sensores a Home Assistant;\n\n\\- descomente <code>user</code> y <code>password</code> bajo <code>mqtt</code> e ingrese su nombre de usuario y contraseña (como una cadena, con comillas) del Broker MQTT;\n\n\\- cambie el puerto en <code>serial</code> -> <code>port</code> al directorio de conexión del stick. En este ejemplo: <code>/dev/ttyUSB0</code>.\n\nEl archivo de configuración ajustado debería verse así:\n\n<LessonCodeWrapper language=\"yaml\">\n# Home Assistant integration (MQTT discovery)\nhomeassistant: true\n# allow new devices to join\npermit_join: true\n# MQTT settings\nmqtt:\n  # MQTT base topic for zigbee2mqtt MQTT messages\n  base_topic: zigbee2mqtt\n  # MQTT server URL\n  server: 'mqtt://localhost'\n  # MQTT server authentication, uncomment if required:\n  user: 'YOUR_USERNAME'\n  password: 'YOUR_PASSWORD'\n# Serial settings\nserial:\n  # Location of CC2531 USB sniffer\n  port: /dev/YOUR_PORT\n</LessonCodeWrapper>\n\n\n**Extra:**\n\nSi ya tiene un adaptador o gateway Zigbee activo en su hogar, y ahora está configurando otro stick, entonces entrarán en conflicto entre sí. Para resolver este problema, debe cambiar el canal en el nuevo dispositivo. Para esto, agregue las siguientes cadenas al final del archivo de configuración:\n\n\n<LessonCodeWrapper language=\"yaml\" codeClass=\"big-code\">\nadvanced:\n  # Optional: ZigBee channel, changing requires re-pairing of all devices. (Note: use a ZLL channel: 11, 15, 20, or 25 to avoid Problems)\n  # (default: 11)\n  channel: 15\n</LessonCodeWrapper>\n</li>\n\n<li>\n\nIniciar Zigbee2MQTT:\n\n<LessonCodeWrapper language=\"bash\" noLines>\ncd /opt/zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnpm start\n</LessonCodeWrapper>\n\nSi se inicia correctamente, verás algo como:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-1.jpg\" alt=\"code\"/>\n</li>\n</List>\n</li>\n\n<li>\n\nEmparejamiento de dispositivo\n\n<List>\n\n<li>\n\nEs hora de conectar tu dispositivo inteligente. La forma más común de cambiar un dispositivo al modo de conexión es mantener presionado su botón de encendido o encenderlo/apagarlo 5 veces. Asegúrate de que Zigbee2MQTT esté en funcionamiento.\n\n<LessonImages src=\"smart-house-course/lesson-4-a-4.gif\" alt=\"code\" imageClasses=\"mb\"/>\n\nCuando el dispositivo se conecte, deberías ver un mensaje como:\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\nZigbee2MQTT:info  2022-07-29 14:44:39: Successfully interviewed '0x00158d0003eeeacf', device has successfully been paired\n</LessonCodeWrapper>\n\nRecuerda el ID del sensor: en este ejemplo — <code>0x00158d0003eeeacf</code>.\n\nAhora deberías ver este sensor con ID en tu interfaz web de Home Assistant. Ve a <code>Configuración</code> -> <code>Dispositivos y Servicios</code> -> <code>Dispositivos</code> para comprobarlo:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-2.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n\nDespués de agregar todos los sensores, puedes detener el programa con <code>Ctrl+C</code>. Si no quieres agregar más dispositivos, puedes abrir el archivo de configuración nuevamente y establecer <code>permit_join:</code> en <code>false</code>.\n</li>\n\n</List>\n</li>\n\n<li>\n\nCreando Servicio para Autostart\n\n<List>\n\n<li>\n\nAhora necesitas crear un servicio. Crea el archivo:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo nano /etc/systemd/system/zigbee2mqtt.service\n</LessonCodeWrapper>\n\nAgrega lo siguiente a este archivo cambiando <code>TU_NOMBRE_DE_USUARIO_DE_RASPPI_AQUÍ</code>. Si no sabes tu nombre de usuario, usa el comando <code>whoami</code>.\n\n<LessonCodeWrapper language=\"bash\">\n[Unit]\nDescription=zigbee2mqtt\nAfter=network.target \n[Service]\nExecStart=/usr/bin/npm start\nWorkingDirectory=/opt/zigbee2mqtt\nStandardOutput=inherit\nStandardError=inherit\nRestart=always\nUser=YOUR_RASPPI_USERNAME_HERE\n[Install]\nWantedBy=multi-user.target\n</LessonCodeWrapper>\n</li>\n\n<li>\n\nVerifica que la configuración funcione:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl start zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsystemctl status zigbee2mqtt.service\n</LessonCodeWrapper>\n\nLa salida debería verse como:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-3.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n</li>\n\n<li>\n\nHabilita el servicio para iniciar Zigbee2MQTT automáticamente al arrancar:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl enable zigbee2mqtt.service\n</LessonCodeWrapper>\n\n</li>\n</List>\n</li>\n</List>","fileInfo":{"path":"es/learn/smart-home-course/gateway-setup-zigbee2mqtt.md","name":"gateway-setup-zigbee2mqtt"},"defaultName":"Sovereign Smart Home with Robonomics and Home Assistant","lastUpdate":"Thu May 04 2023 12:54:33 GMT+0400 (Samara Standard Time)"}},"context":{}}