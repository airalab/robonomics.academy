{"hash":"5d4f08f99729279cbad41c23c8d66dce511a8ae5","data":{"course":{"id":"fddcfdd58a402850da666a43cf7ce4a2","title":"第4课，网关设置：Zigbee2MQTT","description":"家庭助手课程","content":"\n## 介绍\n\n这是一个用于使用Zigbee适配器和Zigbee2MQTT桥接设备的场景设置。如果您有[JetHome USB JetStick Z2](https://jethome.ru/z2/?sl=en)（具有所有必要的固件），您可以简单地按照这些说明进行操作。但是，如果您有另一个适配器，您需要做的第一件事是使用Zigbee2MQTT软件刷写它。您可以在[这里](https://www.zigbee2mqtt.io/guide/adapters/)找到您设备的说明。\n\n您还需要一个智能设备来测试其与Home Assistant的连接。\n\n\n## 说明\n\n<List type=\"numbers\">\n\n<li>\n\n软件安装\n\n<List>\n\n  <li>\n    设置Node.js运行时环境存储库并安装所需的依赖项：\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>sudo curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash - </LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo apt-get install -y nodejs git make g++ gcc</LessonCodeWrapper>\n\n  </li>\n\n  <li>\n    验证已自动安装了正确版本的Node.js（v14.X、V16.x、V17.x或V18.X）和包管理器<code class=\"nowb\">npm</code>（6.X、7.X或8.X）与Node.js一起安装：\n    <LessonCodeWrapper language=\"bash\" noLines>node --version</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm --version</LessonCodeWrapper>\n  </li>\n\n  <li>\n    为Zigbee2MQTT创建一个目录，并将您的用户设置为其所有者：\n    <LessonCodeWrapper language=\"bash\" noLines>sudo mkdir /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo chown -R ${USER}: /opt/zigbee2mqtt</LessonCodeWrapper>\n  </li>\n\n  <li>\n    克隆Zigbee2MQTT存储库：\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\n    git clone --depth 1 --branch 1.28.4 https://github.com/Koenkk/zigbee2mqtt.git /opt/zigbee2mqtt\n    </LessonCodeWrapper>\n  </li>\n\n  <li>\n    安装依赖项。请注意，<code>npm ci</code>可能会产生一些警告，可以忽略。\n    <LessonCodeWrapper language=\"bash\" noLines>cd /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm ci</LessonCodeWrapper>\n  </li>\n\n</List>\n</li>\n\n<li>\n\n连接和配置适配器\n\n<List>\n\n<li>\n\n将Zigbee适配器连接到Raspberry Pi。然后您需要找到stick的位置。为此，请输入以下命令：\n\n<LessonCodeWrapper language=\"bash\" noLines>\nls -l /dev/serial/by-id\n</LessonCodeWrapper>\n\n输出应如下所示：\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noCopyIcon>\nubuntu@ubuntu:~$ ls -l /dev/serial/by-id\ntotal 0\nlrwxrwxrwx 1 root root 13 Oct 10 01:44 usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0 -> ../../ttyUSB0\n</LessonCodeWrapper>\n\n在此示例中，粘连连接目录是<code>ttyUSB0</code>。\n</li>\n\n<li>\n\n在启动Zigbee2MQTT之前编辑<code>configuration.yaml</code>文件：\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnano /opt/zigbee2mqtt/data/configuration.yaml\n</LessonCodeWrapper>\n\n基本配置需要进行一些调整。更改以下语句：\n\n\\- <code>homeassistant：</code>更改为<code>true</code>，它将自动将传感器连接到Home Assistant；\n\n\\- 取消注释<code>mqtt</code>下的<code>user</code>和<code>password</code>，并输入来自MQTT Broker的用户名和密码（作为字符串，带引号）；\n\n\\- 将<code>serial</code> -> <code>port</code>中的端口更改为粘连连接目录。在此示例中：<code>/dev/ttyUSB0</code>。\n\n调整后的配置文件应如下所示：\n\n<LessonCodeWrapper language=\"yaml\">\n# Home Assistant integration (MQTT discovery)\nhomeassistant: true\n# allow new devices to join\npermit_join: true\n# MQTT settings\nmqtt:\n  # MQTT base topic for zigbee2mqtt MQTT messages\n  base_topic: zigbee2mqtt\n  # MQTT server URL\n  server: 'mqtt://localhost'\n  # MQTT server authentication, uncomment if required:\n  user: 'YOUR_USERNAME'\n  password: 'YOUR_PASSWORD'\n# Serial settings\nserial:\n  # Location of CC2531 USB sniffer\n  port: /dev/YOUR_PORT\n</LessonCodeWrapper>\n\n\n**额外的：**\n\n如果您家中已经有一个活动的Zigbee适配器或网关，并且现在正在配置另一个stick，则它们将互相冲突。要解决此问题，您需要在新设备上更改通道。为此，请将以下字符串添加到配置文件的末尾：\n\n\n<LessonCodeWrapper language=\"yaml\" codeClass=\"big-code\">\nadvanced:\n  # Optional: ZigBee channel, changing requires re-pairing of all devices. (Note: use a ZLL channel: 11, 15, 20, or 25 to avoid Problems)\n  # (default: 11)\n  channel: 15\n</LessonCodeWrapper>\n</li>\n\n<li>\n\n启动Zigbee2MQTT：\n\n<LessonCodeWrapper language=\"bash\" noLines>\ncd /opt/zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnpm start\n</LessonCodeWrapper>\n\n如果成功启动，您将看到类似以下内容：\n\n<LessonImages src=\"smart-house-course/lesson-4-a-1.jpg\" alt=\"code\"/>\n</li>\n</List>\n</li>\n\n<li>\n\n配对设备\n\n<List>\n\n<li>\n\n现在是连接您的智能设备的时候了。将设备切换到连接模式的最常见方法是按住其电源按钮或开关5次。确保Zigbee2MQTT正在运行。\n\n<LessonImages src=\"smart-house-course/lesson-4-a-4.gif\" alt=\"code\" imageClasses=\"mb\"/>\n\n当设备连接时，您应该会看到一条消息，如下所示：\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\nZigbee2MQTT:info  2022-07-29 14:44:39: Successfully interviewed '0x00158d0003eeeacf', device has successfully been paired\n</LessonCodeWrapper>\n\n记住传感器的ID：在本例中为<code>0x00158d0003eeeacf</code>。\n\n现在您应该在Home Assistant WebUI中看到带有ID的传感器。转到<code>设置</code> -> <code>设备和服务</code> -> <code>设备</code>进行检查：\n\n<LessonImages src=\"smart-house-course/lesson-4-a-2.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n\n添加完所有传感器后，您可以使用<code>Ctrl+C</code>停止程序。如果您不想再添加更多设备，可以再次打开配置文件，并将<code>permit_join:</code>设置为<code>false</code>。\n</li>\n\n</List>\n</li>\n\n<li>\n\n为自动启动创建服务\n\n<List>\n\n<li>\n\n现在您需要创建一个服务。创建文件：\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo nano /etc/systemd/system/zigbee2mqtt.service\n</LessonCodeWrapper>\n\n将以下内容添加到此文件中，并更改<code>YOUR_RASPPI_USERNAME_HERE</code>。如果您不知道您的用户名，可以使用<code>whoami</code>命令。\n\n<LessonCodeWrapper language=\"bash\">\n[Unit]\nDescription=zigbee2mqtt\nAfter=network.target \n[Service]\nExecStart=/usr/bin/npm start\nWorkingDirectory=/opt/zigbee2mqtt\nStandardOutput=inherit\nStandardError=inherit\nRestart=always\nUser=YOUR_RASPPI_USERNAME_HERE\n[Install]\nWantedBy=multi-user.target\n</LessonCodeWrapper>\n</li>\n\n<li>\n\n验证配置是否有效：\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl start zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsystemctl status zigbee2mqtt.service\n</LessonCodeWrapper>\n\n输出应如下所示：\n\n<LessonImages src=\"smart-house-course/lesson-4-a-3.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n</li>\n\n<li>\n\n启用服务以在启动时自动启动Zigbee2MQTT：\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl enable zigbee2mqtt.service\n</LessonCodeWrapper>\n\n</li>\n</List>\n</li>\n</List>","fileInfo":{"path":"zh/learn/smart-home-course/gateway-setup-zigbee2mqtt.md","name":"gateway-setup-zigbee2mqtt"},"defaultName":"Sovereign Smart Home with Robonomics and Home Assistant","lastUpdate":"Thu May 04 2023 12:54:33 GMT+0400 (Samara Standard Time)"}},"context":{}}