{"hash":"39646b78023bddea786f995e516360c6cbdb9af0","data":{"course":{"id":"0048fd0d7d713003d5f2cb9145df61a6","title":"Урок №4а, Настройка шлюза: Zigbee2MQTT","description":"курс домашнего помощника","content":"\n## Вступление\n\nЭто сценарий настройки для подключения устройств с использованием адаптера Zigbee и моста Zigbee2MQTT. Если у вас есть [JetHome USB JetStick Z2](https://jethome.ru/z2/?sl=en) (который имеет все необходимые прошивки), вы можете просто продолжить с этими инструкциями. Однако, если у вас есть другой адаптер, первое, что вам нужно сделать, это прошить его программным обеспечением Zigbee2MQTT. Инструкции для вашего устройства можно найти [здесь](https://www.zigbee2mqtt.io/guide/adapters/).\n\nВам также понадобится умное устройство для проверки его подключения к Home Assistant.\n\n\n## Инструкции\n\n<List type=\"numbers\">\n\n<li>\n\nУстановка программного обеспечения\n\n<List>\n\n  <li>\n    Настройте репозиторий среды выполнения Node.js и установите его с необходимыми зависимостями:\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>sudo curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash - </LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo apt-get install -y nodejs git make g++ gcc</LessonCodeWrapper>\n\n  </li>\n\n  <li>\n    Убедитесь, что правильные версии Node.js (v14.X, V16.x, V17.x или V18.X) и менеджер пакетов <code class=\"nowb\">npm</code> (6.X, 7.X или 8.X), автоматически установленные с Node.js, были установлены:\n    <LessonCodeWrapper language=\"bash\" noLines>node --version</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm --version</LessonCodeWrapper>\n  </li>\n\n  <li>\n    Создайте каталог для Zigbee2MQTT и установите вашего пользователя владельцем:\n    <LessonCodeWrapper language=\"bash\" noLines>sudo mkdir /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo chown -R ${USER}: /opt/zigbee2mqtt</LessonCodeWrapper>\n  </li>\n\n  <li>\n    Клонируйте репозиторий Zigbee2MQTT:\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\n    git clone --depth 1 --branch 1.28.4 https://github.com/Koenkk/zigbee2mqtt.git /opt/zigbee2mqtt\n    </LessonCodeWrapper>\n  </li>\n\n  <li>\n    Установите зависимости. Обратите внимание, что <code>npm ci</code> может выдавать предупреждения, которые можно игнорировать.\n    <LessonCodeWrapper language=\"bash\" noLines>cd /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm ci</LessonCodeWrapper>\n  </li>\n\n</List>\n</li>\n\n<li>\n\nПодключение и настройка адаптера\n\n<List>\n\n<li>\n\nПодключите адаптер Zigbee к Raspberry Pi. Затем вам нужно найти местоположение палки. Для этого введите следующую команду:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nls -l /dev/serial/by-id\n</LessonCodeWrapper>\n\nВывод должен выглядеть так:\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noCopyIcon>\nubuntu@ubuntu:~$ ls -l /dev/serial/by-id\ntotal 0\nlrwxrwxrwx 1 root root 13 Oct 10 01:44 usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0 -> ../../ttyUSB0\n</LessonCodeWrapper>\n\nВ этом примере каталог подключения устройства - <code>ttyUSB0</code>.\n</li>\n\n<li>\n\nОтредактируйте файл <code>configuration.yaml</code> перед запуском Zigbee2MQTT:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnano /opt/zigbee2mqtt/data/configuration.yaml\n</LessonCodeWrapper>\n\nОсновная конфигурация требует нескольких настроек. Измените следующие утверждения:\n\n\\- <code>homeassistant:</code> на <code>true</code>, это автоматически подключит датчики к Home Assistant;\n\n\\- раскомментируйте <code>user</code> и <code>password</code> под <code>mqtt</code> и введите свое имя пользователя и пароль (как строку, в кавычках) от MQTT брокера;\n\n\\- измените порт в <code>serial</code> -> <code>port</code> на каталог подключения устройства. В этом примере: <code>/dev/ttyUSB0</code>.\n\nОтредактированный файл конфигурации должен выглядеть так:\n\n<LessonCodeWrapper language=\"yaml\">\n# Home Assistant integration (MQTT discovery)\nhomeassistant: true\n# allow new devices to join\npermit_join: true\n# MQTT settings\nmqtt:\n  # MQTT base topic for zigbee2mqtt MQTT messages\n  base_topic: zigbee2mqtt\n  # MQTT server URL\n  server: 'mqtt://localhost'\n  # MQTT server authentication, uncomment if required:\n  user: 'YOUR_USERNAME'\n  password: 'YOUR_PASSWORD'\n# Serial settings\nserial:\n  # Location of CC2531 USB sniffer\n  port: /dev/YOUR_PORT\n</LessonCodeWrapper>\n\n\n**Дополнительно:**\n\nЕсли у вас уже есть активный адаптер Zigbee или шлюз в вашем доме, и вы сейчас настраиваете другое устройство, то они будут конфликтовать друг с другом. Чтобы решить эту проблему, вам нужно изменить канал на новом устройстве. Для этого добавьте следующие строки в конец файла конфигурации:\n\n\n<LessonCodeWrapper language=\"yaml\" codeClass=\"big-code\">\nadvanced:\n  # Optional: ZigBee channel, changing requires re-pairing of all devices. (Note: use a ZLL channel: 11, 15, 20, or 25 to avoid Problems)\n  # (default: 11)\n  channel: 15\n</LessonCodeWrapper>\n</li>\n\n<li>\n\nНачать Zigbee2MQTT:\n\n<LessonCodeWrapper language=\"bash\" noLines>\ncd /opt/zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnpm start\n</LessonCodeWrapper>\n\nЕсли запущено успешно, вы увидите что-то вроде:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-1.jpg\" alt=\"code\"/>\n</li>\n</List>\n</li>\n\n<li>\n\nПарное устройство\n\n<List>\n\n<li>\n\nПора подключить ваше умное устройство. Самый распространенный способ перевода устройства в режим подключения - удерживать его кнопку питания или включать/выключать его 5 раз. Убедитесь, что Zigbee2MQTT работает.\n\n<LessonImages src=\"smart-house-course/lesson-4-a-4.gif\" alt=\"code\" imageClasses=\"mb\"/>\n\nКогда устройство подключится, вы должны увидеть сообщение вроде:\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\nZigbee2MQTT:info  2022-07-29 14:44:39: Successfully interviewed '0x00158d0003eeeacf', device has successfully been paired\n</LessonCodeWrapper>\n\nЗапомните идентификатор датчика: в этом примере - <code>0x00158d0003eeeacf</code>.\n\nТеперь вы должны увидеть этот датчик с идентификатором в вашем веб-интерфейсе Home Assistant. Перейдите к <code>Настройка</code> -> <code>Устройства и Сервисы</code> -> <code>Устройства</code> для проверки:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-2.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n\nПосле добавления всех датчиков вы можете остановить программу с помощью <code>Ctrl+C</code>. Если вы не хотите добавлять больше устройств, вы можете снова открыть файл конфигурации и установить <code>permit_join:</code> в <code>false</code>.\n</li>\n\n</List>\n</li>\n\n<li>\n\nСоздание Службы для Автозапуска\n\n<List>\n\n<li>\n\nТеперь вам нужно создать службу. Создайте файл:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo nano /etc/systemd/system/zigbee2mqtt.service\n</LessonCodeWrapper>\n\nДобавьте следующее в этот файл, изменив <code>YOUR_RASPPI_USERNAME_HERE</code>. Если вы не знаете свое имя пользователя, используйте команду <code>whoami</code>.\n\n<LessonCodeWrapper language=\"bash\">\n[Unit]\nDescription=zigbee2mqtt\nAfter=network.target \n[Service]\nExecStart=/usr/bin/npm start\nWorkingDirectory=/opt/zigbee2mqtt\nStandardOutput=inherit\nStandardError=inherit\nRestart=always\nUser=YOUR_RASPPI_USERNAME_HERE\n[Install]\nWantedBy=multi-user.target\n</LessonCodeWrapper>\n</li>\n\n<li>\n\nПроверьте, что конфигурация работает:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl start zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsystemctl status zigbee2mqtt.service\n</LessonCodeWrapper>\n\nВывод должен выглядеть так:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-3.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n</li>\n\n<li>\n\nВключите службу для автоматического запуска Zigbee2MQTT при загрузке:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl enable zigbee2mqtt.service\n</LessonCodeWrapper>\n\n</li>\n</List>\n</li>\n</List>","fileInfo":{"path":"ru/learn/smart-home-course/gateway-setup-zigbee2mqtt.md","name":"gateway-setup-zigbee2mqtt"},"defaultName":"Sovereign Smart Home with Robonomics and Home Assistant","lastUpdate":"Thu May 04 2023 12:54:33 GMT+0400 (Samara Standard Time)"}},"context":{}}