{"hash":"f0f5c02be608963a98931b1ff3d7b952f1efb26f","data":{"course":{"id":"01033972bc3321db5f73931a64aed6cb","title":"Урок №4b, Настройка шлюза: Robonomics SLS Gateway","description":"курс домашнего помощника","content":"\n## О чем это\n\nЭто сценарий настройки для подключения устройств с использованием шлюза Robonomics SLS. Robonomics черпал вдохновение в дизайне шлюза, разработанного проектом [Smart Logic System](https://github.com/slsys/Gateway) и модифицировал часть схемотехники. Вы можете заказать шлюз у Robonomics или построить свой собственный, используя наши [чертежи](https://oshwlab.com/ludovich88/robonomics_sls_gateway_v01).\n\nВы установите необходимое программное обеспечение для шлюза, настроите его и подключите к Home Assistant.\n\n<robo-academy-note type=\"note\" title=\"Attention\">\n  SmartRF Flash Programmer, программа для обновления прошивки, требует операционную систему Windows.\n</robo-academy-note>\n\n## Инструкции\n\n<List type=\"numbers\">\n\n<li>\n\nУстановка прошивки микроконтроллера Zigbee\n\n<List>\n\n<li>\n\nСначала вам нужно прошить микроконтроллер CC2652P шлюза. Установите переключатели <code>ON</code> на нижней части SLS Gateway для переключателей <code>2</code>, <code>4</code> и <code>7</code>, остальные должны быть <code>OFF</code>.\n\n<LessonImages src=\"smart-house-course/lesson-4-b-1.png\" alt=\"controllers\"/>\n</li>\n\n<li>\n\nПодключите шлюз к компьютеру с помощью кабеля USB-A<>USB-C.\n\n<robo-academy-note type=\"warning\" title=\"WARNING\">\n  Пожалуйста, используйте только кабели типа USB-A<>USB-C, потому что на данный момент шлюз не поддерживает тип USB-C<>USB-C.\n</robo-academy-note>\n\n</li>\n\n<li>\n\nПрошивка CC2652 требует SmartRF Flash Programmer v2 от Texas Instrument. Скачайте ее с [официального сайта](https://www.ti.com/tool/download/FLASH-PROGRAMMER-2), а затем установите.\n\n</li>\n\n<li>\n\nСкачайте прошивку для микроконтроллера CC2652P с [репозитория GitHub](https://github.com/egony/cc2652p_cc1352p_RF-STAR/tree/main/firmware/coordinator).\n\n</li>\n\n<li>\n\nЗапустите программу. В окне <code>Подключенное устройство</code> выберите микроконтроллер CC2652P, укажите путь к прошивке, установите флаги на <code>Erase, Program, Verify</code> как на картинке и нажмите <code>Start</code>.\n\n<LessonImages src=\"smart-house-course/lesson-4-b-2.png\" alt=\"tutorial\" imageClasses=\"mb\"/>\n\nПосле успешной прошивки вы увидите сообщение <code>Success!</code>. Теперь вы можете отключить USB-кабель.\n\n</li>\n</List>\n</li>\n\n<li>\n\nУстановка прошивки микроконтроллера\n\n<List>\n\n<li>\n\nТеперь вам нужно настроить шлюз для установки программного обеспечения. Мы рекомендуем вам обновить прошивку, подключив шлюз напрямую к вашему Raspberry Pi и вводя все следующие команды на этом устройстве. \n\n</li>\n\n<li>\n\nУстановите переключатели <code>ON</code> на нижней части шлюза SLS для переключателей <code>1</code> и <code>3</code>, остальные должны быть <code>OFF</code>. Затем подключите шлюз к вашему Raspberry Pi через порт USB типа-C.\n\n<LessonImages src=\"smart-house-course/lesson-4-b-3.gif\" alt=\"tutorial\" imageClasses=\"mb\"/>\n\n</li>\n\n<li>\n\nПодключитесь к Raspberry Pi через SSH.\n\n<LessonCodeWrapper language=\"bash\" noLines>\nssh ubuntu@192.168.xxx.xxx\n</LessonCodeWrapper>\n\n</li>\n\n<li>\n\nКлонируйте репозиторий с прошивкой:\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\ngit clone https://github.com/airalab/robonomics-hass-utils.git\n</LessonCodeWrapper>\n</li>\n\n<li>\n\nДля прошивки шлюза SLS вам нужно запустить скрипты <code>Clear</code> и <code>Flash_16mb</code>:\n\n<LessonCodeWrapper language=\"bash\" noLines>\ncd robonomics-hass-utils/esp_firmware/linux\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo chmod +x Clear.sh\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo chmod +x Flash_16mb.sh\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\n./Clear.sh\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\n./Flash_16mb.sh\n</LessonCodeWrapper>\n</li>\n\n<li class=\"no-bullet\">\n\n\\- **Устранение неполадок**\n\nЕсли у вас возникают проблемы с обновлением прошивки шлюза, вам нужно предпринять дополнительные шаги:\n\n<List>\n\n<li>\n\nУбедитесь, что у вас установлен модуль pySerial:\n\n<LessonCodeWrapper language=\"bash\" noLines>\npip install pyserial\n</LessonCodeWrapper>\n\n</li>\n\n<li>\n\nПредоставьте вашему пользователю права доступа к USB-порту:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo usermod -a -G dialout $USER\n</LessonCodeWrapper>\n\n</li>\n\n<li>\n\nВ некоторых случаях необходимо изменить настройку пропускной способности в скрипте для обновления прошивки. Откройте скрипт <code>Flash_16mb.sh</code> с помощью редактора nano и измените параметр baud с <code>921600</code> на меньшее значение (например, <code>115200</code>).\n</li>\n</List>\n</li>\n\n<li class=\"no-bullet\">\n\n\\- **Дополнительно**\n\nМы также предоставляем варианты обновления прошивки с использованием других операционных систем (macOS и Windows). Вы можете найти соответствующие скрипты в папке, название которой зависит от вашей ОС.\n\n</li>\n</List>\n</li>\n\n<li>\n\nНастройка шлюза\n\n<List>\n\n<li>\n\nУстановите переключатели на задней стороне шлюза в новое положение. Переключатели <code>5</code> (RX Zigbee to ESP) и <code>6</code> (TX Zigbee to ESP) должны быть в положении <code>ON</code>, остальные должны быть в положении <code>OFF</code>.\n\n\n<LessonImages src=\"smart-house-course/lesson-4-b-4.gif\" alt=\"tutorial\" imageClasses=\"mb\"/>\n\n</li>\n\n<li>\n\nПодключите кабель питания типа C. Индикаторный свет в центре должен загореться зеленым.\n\n</li>\n\n<li>\n\nПри первом запуске шлюз начнет передавать Wi-Fi с SSID <code>zgw****</code>. Подключитесь к этой сети. Имейте в виду, что сигнал может быть довольно слабым, поэтому лучше держать шлюз SLS ближе к вашему компьютеру.\n\nЕсли соединение установлено успешно, откроется веб-интерфейс (или вы можете найти его по адресу 192.168.1.1).\n\n</li>\n\n<li>\n\nПерейдите на страницу Wi-Fi и введите ваши учетные данные Wi-Fi, введя пользователя / пароль и нажав кнопку <code>Save</code>. Затем нажмите кнопку <code>Reboot</code>. Шлюз перезагрузится и подключится к вашей Wi-Fi сети.\n\n<LessonVideo  :videos=\"[{src: 'https://crustipfs.info/ipfs/QmSht6roENzrV6oqsQ1a5gp6GVCz54EDZdPAP8XVh9SCwH', type:'mp4'}]\" />\n\n</li>\n\n<li>\n\nНайдите локальный IP-адрес шлюза SLS для доступа к веб-интерфейсу. Для этого вы можете использовать приложение [Fing](https://www.fing.com/products) или <code>arp -a</code> в вашем терминале или Nmap: \n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo nmap -sP 192.168.xxx.0/24\n</LessonCodeWrapper>\n\nгде <code class=\"bold\">xxx</code> - ваш IP-адрес в локальной сети. Имя шлюза должно выглядеть так: <code>zgw****</code>. Откройте веб-интерфейс шлюза, вставив IP-адрес шлюза в браузер.\n</li>\n\n<li>\n\nПерейдите в <code>Настройки</code> -> <code>Аппаратное обеспечение</code> и убедитесь, что настройки соответствуют изображению. Поправьте настройки при необходимости и нажмите кнопку <code>Сохранить</code>:\n\n<LessonVideo  :videos=\"[{src: 'https://crustipfs.info/ipfs/QmeSksMxU9xkvvK7f81WDAYULiMFokK7P7KDVYEjv2MHjn', type:'mp4'}]\" />\n\nТаблица с необходимыми значениями:\n\n\n| Field        \t         | **Value**          |                                                                     \t\n|------------------------|--------------------|\n| Zigbee module          | TI                 |\n| Zigbee UART RX         | 22                 |\n| Zigbee UART TX         | 23                 |\n| Zigbee RST Pin         | 18                 |\n| Zigbee BSL Pin         | 19                 |\n| Button Mode            | 33 (pullUP - true) |\n| Number addressable leds| 0                  |\n| Led Red (or addr)      | 21                 |\n| Led Green              | 5                  |\n| Led Blue               | 27                 |\n| I2C SDA                | 255                |\n| I2C SCL                | 255                |\n\n</li>\n\n<li>\n\nЗатем перезагрузите шлюз. Выберите <code>Действия</code> -> <code>Перезагрузить систему</code> в правом верхнем углу. Убедитесь, что шлюз работает правильно с микроконтроллером CC2652P в окне информации Zigbee. Состояние устройства должно быть <code>OK</code>.\n\n</li>\n\n<li>\n\nПерезагрузите шлюз. Выберите <code>Действия</code> -> <code>Перезагрузить</code> систему в правом верхнем углу.\n\n</li>\n\n<li>\n\nНастройте автоматическое добавление устройств в Home Assistant. Перейдите в <code>Zigbee</code> -> <code>Настройки</code>, затем выберите <code>Обнаружение Home Assistant MQTT</code> и <code>Очистить состояния</code>. Сохраните изменения и снова перезагрузите шлюз SLS.\n\n<LessonVideo  :videos=\"[{src: 'https://crustipfs.info/ipfs/QmVZMB1xQeB6ZLfSR6aUrN6cRSF296s8CMJt7E2jBJ5MjZ', type:'mp4'}]\" />\n\n</li>\n\n<li class=\"no-bullet\">\n\n\\- **Дополнительно**:\n\nЕсли у вас уже есть активный шлюз SLS в доме, и вы сейчас настраиваете еще один, то они будут конфликтовать друг с другом. Чтобы решить эту проблему, вам нужно изменить канал на новом устройстве.\n\nДля этого перейдите в <code>Zigbee</code> -> <code>Настройки</code> и измените канал на другой (например, канал 15).\n\n</li>\n\n<li>\n\nПодключите ваши устройства, перейдя в <code>Zigbee</code> -> <code>Присоединиться</code>. Поместите ваши датчики в режим сопряжения, наиболее распространенным способом перевода устройства в режим подключения является удержание его кнопки питания или переключение их вкл/выкл 5 раз. Нажмите кнопку <code>Включить присоединение</code>, чтобы начать поиск устройств Zigbee. Вы увидите активные датчики.\n\n</li>\n</List>\n</li>\n\n<li>\n\nПодключение шлюза SLS к Home Assistant\n\n<List>\n\n<li>\n\nВам нужно настроить MQTT на шлюзе SLS. Вернитесь на веб-интерфейс вашего шлюза SLS и перейдите в <code>Настройки</code> -> <code>Ссылка</code> -> <code>Настройка MQTT</code>.\n\n<LessonVideo  :videos=\"[{src: 'https://crustipfs.info/ipfs/QmdNKDqwwy87VQEDDVsX5kpaDQm9wKKPEJUNJnhnjx6e5y', type:'mp4'}]\" />\n\n</li>\n\n<li>\n\nДобавьте адрес вашего брокера (адрес Raspberry Pi с Home Assistant в локальной сети, вы можете найти его с помощью приложения [Fing](https://www.fing.com/products) или используя команду <code>ip -a</code> на вашем RPi), порт (по умолчанию 1883), имя пользователя и пароль вашего брокера (которые вы создали ранее) и имя темы (вы можете выбрать любое). Также, локальный IP-адрес Raspberry Pi должен быть статическим.\n\nНе забудьте нажать <code>Включить</code> и <code>Сохранить состояния</code>.\n\n</li>\n\n<li>\n\nСохраните изменения. Теперь устройства будут автоматически отображаться в Home Assistant.\n\n</li>\n</List>\n\n</li>\n\n<li>\n\nПодключение устройств \n\n<List>\n\n<li>\n\nПодключите ваши устройства, перейдя в <code>Zigbee</code> -> <code>Присоединиться</code>. Поместите ваши датчики в режим сопряжения, наиболее распространенным способом перевода устройства в режим подключения является удержание его кнопки питания или переключение их вкл/выкл 5 раз.\n\n<LessonImages src=\"smart-house-course/lesson-4-a-4.gif\" alt=\"tutorial\" imageClasses=\"mb\"/>\n\n<LessonVideo  :videos=\"[{src: 'https://crustipfs.info/ipfs/Qmdq3PBNY88QbYYqakwSLG2vn3mVUom3w3wsSWfTd1pzJA', type:'mp4'}]\" />\n\n</li>\n\n<li>\n\nНажмите кнопку Включить присоединение, чтобы начать поиск устройств Zigbee. Вы увидите активные датчики.\n\n</li>\n\n</List>\n</li>\n\n</List>","fileInfo":{"path":"ru/learn/smart-home-course/gateway-setup-robonomics-sls-gateway.md","name":"gateway-setup-robonomics-sls-gateway"},"defaultName":"Sovereign Smart Home with Robonomics and Home Assistant","lastUpdate":"Thu May 18 2023 16:16:20 GMT+0400 (Samara Standard Time)"}},"context":{}}