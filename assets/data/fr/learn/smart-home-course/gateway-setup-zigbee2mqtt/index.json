{"hash":"39646b78023bddea786f995e516360c6cbdb9af0","data":{"course":{"id":"56950682140f8c3b35e406a9b383fff9","title":"Leçon n°4a, Configuration de la passerelle : Zigbee2MQTT","description":"cours d'assistant domestique","content":"\n## Introduction\n\nIl s'agit d'une configuration de scénario pour connecter des appareils à l'aide de l'adaptateur Zigbee et du pont Zigbee2MQTT. Si vous avez le [JetHome USB JetStick Z2](https://jethome.ru/z2/?sl=en) (qui possède tous les micrologiciels nécessaires), vous pouvez simplement suivre ces instructions. Cependant, si vous avez un autre adaptateur, la première chose à faire est de le flasher avec le logiciel Zigbee2MQTT. Vous pouvez trouver des instructions pour votre appareil [ici](https://www.zigbee2mqtt.io/guide/adapters/).\n\nVous aurez également besoin d'un appareil intelligent pour tester sa connexion à Home Assistant.\n\n\n## Instructions\n\n<List type=\"numbers\">\n\n<li>\n\nInstallation du logiciel\n\n<List>\n\n  <li>\n    Configurez le référentiel de l'environnement d'exécution Node.js et installez-le avec les dépendances requises:\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>sudo curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash - </LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo apt-get install -y nodejs git make g++ gcc</LessonCodeWrapper>\n\n  </li>\n\n  <li>\n    Vérifiez que les versions correctes de Node.js (v14.X, V16.x, V17.x ou V18.X) et du gestionnaire de paquets <code class=\"nowb\">npm</code> (6.X, 7.X ou 8.X) installées automatiquement avec Node.js, ont été installées:\n    <LessonCodeWrapper language=\"bash\" noLines>node --version</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm --version</LessonCodeWrapper>\n  </li>\n\n  <li>\n    Créez un répertoire pour Zigbee2MQTT et définissez votre utilisateur comme propriétaire de celui-ci:\n    <LessonCodeWrapper language=\"bash\" noLines>sudo mkdir /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>sudo chown -R ${USER}: /opt/zigbee2mqtt</LessonCodeWrapper>\n  </li>\n\n  <li>\n    Clonez le référentiel Zigbee2MQTT:\n    <LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\n    git clone --depth 1 --branch 1.28.4 https://github.com/Koenkk/zigbee2mqtt.git /opt/zigbee2mqtt\n    </LessonCodeWrapper>\n  </li>\n\n  <li>\n    Installer les dépendances. Notez que la commande <code>npm ci</code> peut produire des avertissements qui peuvent être ignorés.\n    <LessonCodeWrapper language=\"bash\" noLines>cd /opt/zigbee2mqtt</LessonCodeWrapper>\n    <LessonCodeWrapper language=\"bash\" noLines>npm ci</LessonCodeWrapper>\n  </li>\n\n</List>\n</li>\n\n<li>\n\nConnexion et configuration de l'adaptateur\n\n<List>\n\n<li>\n\nConnectez l'adaptateur Zigbee au Raspberry Pi. Ensuite, vous devez trouver l'emplacement de la clé. Pour cela, saisissez la commande suivante:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nls -l /dev/serial/by-id\n</LessonCodeWrapper>\n\nLa sortie devrait ressembler à:\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noCopyIcon>\nubuntu@ubuntu:~$ ls -l /dev/serial/by-id\ntotal 0\nlrwxrwxrwx 1 root root 13 Oct 10 01:44 usb-Silicon_Labs_CP2102_USB_to_UART_Bridge_Controller_0001-if00-port0 -> ../../ttyUSB0\n</LessonCodeWrapper>\n\nDans cet exemple, le répertoire de connexion du stick est <code>ttyUSB0</code>.\n</li>\n\n<li>\n\nModifier le fichier <code>configuration.yaml</code> avant de démarrer Zigbee2MQTT:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnano /opt/zigbee2mqtt/data/configuration.yaml\n</LessonCodeWrapper>\n\nLa configuration de base nécessite quelques ajustements. Changer les déclarations suivantes:\n\n\\- <code>homeassistant:</code> en <code>true</code>, cela connectera automatiquement les capteurs à Home Assistant;\n\n\\- décommenter <code>user</code> et <code>password</code> sous <code>mqtt</code> et entrer votre nom d'utilisateur et mot de passe (en tant que chaîne, entre guillemets) du courtier MQTT;\n\n\\- changer le port dans <code>serial</code> -> <code>port</code> pour le répertoire de connexion du stick. Dans cet exemple: <code>/dev/ttyUSB0</code>.\n\nLe fichier de configuration ajusté devrait ressembler à ceci:\n\n<LessonCodeWrapper language=\"yaml\">\n# Home Assistant integration (MQTT discovery)\nhomeassistant: true\n# allow new devices to join\npermit_join: true\n# MQTT settings\nmqtt:\n  # MQTT base topic for zigbee2mqtt MQTT messages\n  base_topic: zigbee2mqtt\n  # MQTT server URL\n  server: 'mqtt://localhost'\n  # MQTT server authentication, uncomment if required:\n  user: 'YOUR_USERNAME'\n  password: 'YOUR_PASSWORD'\n# Serial settings\nserial:\n  # Location of CC2531 USB sniffer\n  port: /dev/YOUR_PORT\n</LessonCodeWrapper>\n\n\n**Supplémentaire:**\n\nSi vous avez déjà un adaptateur Zigbee actif ou une passerelle dans votre maison, et que vous configurez maintenant un autre stick, ils entreront en conflit l'un avec l'autre. Pour résoudre ce problème, vous devez changer le canal sur le nouveau périphérique. Pour cela, ajoutez les chaînes suivantes à la fin du fichier de configuration:\n\n\n<LessonCodeWrapper language=\"yaml\" codeClass=\"big-code\">\nadvanced:\n  # Optional: ZigBee channel, changing requires re-pairing of all devices. (Note: use a ZLL channel: 11, 15, 20, or 25 to avoid Problems)\n  # (default: 11)\n  channel: 15\n</LessonCodeWrapper>\n</li>\n\n<li>\n\nDémarrer Zigbee2MQTT:\n\n<LessonCodeWrapper language=\"bash\" noLines>\ncd /opt/zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nnpm start\n</LessonCodeWrapper>\n\nSi le démarrage est réussi, vous verrez quelque chose comme:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-1.jpg\" alt=\"code\"/>\n</li>\n</List>\n</li>\n\n<li>\n\nAppairage de l'appareil\n\n<List>\n\n<li>\n\nIl est temps de connecter votre appareil intelligent. La manière la plus courante de passer un appareil en mode de connexion est de maintenir enfoncé son bouton d'alimentation ou de les allumer/éteindre 5 fois. Assurez-vous que Zigbee2MQTT est en cours d'exécution.\n\n<LessonImages src=\"smart-house-course/lesson-4-a-4.gif\" alt=\"code\" imageClasses=\"mb\"/>\n\nLorsque l'appareil se connecte, vous devriez voir un message comme:\n\n<LessonCodeWrapper language=\"bash\" codeClass=\"big-code\" noLines>\nZigbee2MQTT:info  2022-07-29 14:44:39: Successfully interviewed '0x00158d0003eeeacf', device has successfully been paired\n</LessonCodeWrapper>\n\nMémorisez l'ID du capteur: dans cet exemple - <code>0x00158d0003eeeacf</code>.\n\nMaintenant, vous devriez voir ce capteur avec l'ID dans votre interface Web Home Assistant. Allez dans <code>Paramètres</code> -> <code>Appareils et services</code> -> <code>Appareils</code> pour le vérifier:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-2.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n\nAprès avoir ajouté tous les capteurs, vous pouvez arrêter le programme avec <code>Ctrl+C</code>. Si vous ne voulez pas ajouter d'autres appareils, vous pouvez ouvrir à nouveau le fichier de configuration et définir <code>permit_join:</code> sur <code>false</code>.\n</li>\n\n</List>\n</li>\n\n<li>\n\nCréation du service pour le démarrage automatique\n\n<List>\n\n<li>\n\nMaintenant, vous devez créer un service. Créez le fichier:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo nano /etc/systemd/system/zigbee2mqtt.service\n</LessonCodeWrapper>\n\nAjoutez ce qui suit à ce fichier en changeant <code>VOTRE_NOM_UTILISATEUR_RASPPI_ICI</code>. Si vous ne connaissez pas votre nom d'utilisateur, utilisez la commande <code>whoami</code>.\n\n<LessonCodeWrapper language=\"bash\">\n[Unit]\nDescription=zigbee2mqtt\nAfter=network.target \n[Service]\nExecStart=/usr/bin/npm start\nWorkingDirectory=/opt/zigbee2mqtt\nStandardOutput=inherit\nStandardError=inherit\nRestart=always\nUser=YOUR_RASPPI_USERNAME_HERE\n[Install]\nWantedBy=multi-user.target\n</LessonCodeWrapper>\n</li>\n\n<li>\n\nVérifiez que la configuration fonctionne:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl start zigbee2mqtt\n</LessonCodeWrapper>\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsystemctl status zigbee2mqtt.service\n</LessonCodeWrapper>\n\nLa sortie devrait ressembler à:\n\n<LessonImages src=\"smart-house-course/lesson-4-a-3.jpg\" alt=\"code\" imageClasses=\"mb\"/>\n</li>\n\n<li>\n\nActivez le service pour démarrer Zigbee2MQTT automatiquement au démarrage:\n\n<LessonCodeWrapper language=\"bash\" noLines>\nsudo systemctl enable zigbee2mqtt.service\n</LessonCodeWrapper>\n\n</li>\n</List>\n</li>\n</List>","fileInfo":{"path":"fr/learn/smart-home-course/gateway-setup-zigbee2mqtt.md","name":"gateway-setup-zigbee2mqtt"},"defaultName":"Sovereign Smart Home with Robonomics and Home Assistant","lastUpdate":"Thu May 04 2023 12:54:33 GMT+0400 (Samara Standard Time)"}},"context":{}}